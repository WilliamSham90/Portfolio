<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>William's Slots - Premium Casino</title>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Orbitron:wght@400;700;900&family=Russo+One&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #ffd700;
            --gold-dark: #b8860b;
            --casino-red: #dc143c;
            --casino-purple: #2d1b4e;
            --casino-dark: #0f0a1a;
            --neon-green: #39ff14;
            --neon-pink: #ff1493;
            --neon-orange: #ff6600;
            
            --reel-width: 100px;
            --symbol-height: 90px;
            --visible-rows: 3;
            --reel-count: 5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow-x: hidden; }

        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(180deg, #1a0a2e 0%, var(--casino-dark) 50%, #1a0a2e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 10px;
        }

        .game-container {
            background: linear-gradient(180deg, var(--casino-purple) 0%, var(--casino-dark) 100%);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 3px solid var(--gold);
            max-width: 700px;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .logo {
            font-family: 'Righteous', cursive;
            font-size: 1.5rem;
            background: linear-gradient(180deg, var(--gold) 0%, var(--gold-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-buttons { display: flex; gap: 8px; }

        .header-btn {
            background: linear-gradient(180deg, #3a2a5a 0%, #2a1a4a 100%);
            border: 2px solid var(--gold);
            color: var(--gold);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .header-btn:hover {
            background: linear-gradient(180deg, #4a3a6a 0%, #3a2a5a 100%);
            transform: scale(1.05);
        }

        .header-btn.sound-off { opacity: 0.5; }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
            padding: 8px 15px;
            border-radius: 10px;
            border: 2px solid var(--gold);
            text-align: center;
            min-width: 100px;
            flex: 1;
            max-width: 150px;
        }

        .stat-label { font-size: 0.5rem; color: var(--gold); letter-spacing: 1px; }
        .stat-value { font-size: 1.1rem; font-weight: 900; }
        .balance-value { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }
        .win-value { color: var(--gold); text-shadow: 0 0 10px var(--gold); transition: all 0.3s; }
        .win-value.big-win { color: var(--neon-pink); animation: bigWinPulse 0.3s ease-in-out infinite alternate; }

        @keyframes bigWinPulse { from { transform: scale(1); } to { transform: scale(1.1); } }

        .win-message {
            min-height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .win-message-text {
            font-size: 0.9rem;
            color: var(--gold);
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .win-message-text.show { opacity: 1; }

        .bonus-banner {
            display: none;
            border-radius: 8px;
            padding: 8px 15px;
            text-align: center;
            margin-bottom: 8px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .bonus-banner.free-spins {
            background: linear-gradient(90deg, #1a4a1a 0%, #0d3d0d 100%);
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
        }

        .bonus-banner.sticky-bonus {
            background: linear-gradient(90deg, #4a1a4a 0%, #3d0d3d 100%);
            border: 2px solid var(--neon-pink);
            color: var(--neon-pink);
        }

        .bonus-banner.active { display: block; }

        .slot-machine {
            background: linear-gradient(180deg, #080808 0%, #101018 50%, #080808 100%);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 12px;
            border: 2px solid #333;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.9);
            position: relative;
        }

        .reels-area {
            display: flex;
            align-items: stretch;
        }

        .line-numbers {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 0;
            width: 28px;
            flex-shrink: 0;
            gap: 1px;
        }

        .line-number {
            width: 22px;
            height: 17px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7.5px;
            font-weight: bold;
            color: #000;
            cursor: default;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }

        .line-number.winner {
            transform: scale(1.3);
            box-shadow: 0 0 10px currentColor;
            z-index: 5;
        }

        .reels-wrapper {
            flex: 1;
            overflow: hidden;
            border-radius: 8px;
            background: #050508;
            position: relative;
        }

        .reels-container {
            display: flex;
            gap: 4px;
            justify-content: center;
            padding: 3px;
        }

        /* SVG Payline overlay */
        .paylines-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            overflow: visible;
        }

        .payline-glow {
            fill: none;
            stroke-width: 9;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0;
            filter: blur(4px);
        }

        .payline-glow.active {
            opacity: 0.35;
            animation: paylineGlow 1.5s ease-in-out infinite;
        }

        .payline-line {
            fill: none;
            stroke-width: 3.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .payline-line.active {
            opacity: 0.9;
            animation: paylinePulse 1.5s ease-in-out infinite;
        }

        .payline-dot { opacity: 0; }
        .payline-dot.active { opacity: 1; }

        @keyframes paylinePulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        @keyframes paylineGlow {
            0%, 100% { opacity: 0.25; }
            50% { opacity: 0.45; }
        }

        .reel {
            width: var(--reel-width);
            height: calc(var(--symbol-height) * var(--visible-rows));
            overflow: hidden;
            background: linear-gradient(180deg, #0a0a0f 0%, #15151f 50%, #0a0a0f 100%);
            border-radius: 6px;
            border: 1px solid #2a2a3a;
        }

        .reel.winner-column { animation: columnGlow 0.5s ease-in-out infinite alternate; }

        @keyframes columnGlow {
            from { box-shadow: inset 0 0 20px rgba(255, 215, 0, 0.3); border-color: var(--gold); }
            to { box-shadow: inset 0 0 40px rgba(255, 215, 0, 0.5); border-color: #fff; }
        }

        .reel.sticky { border: 2px solid var(--neon-pink); box-shadow: inset 0 0 15px rgba(255, 20, 147, 0.3); }
        .reel-strip { display: flex; flex-direction: column; will-change: transform; }
        .reel.spinning .reel-strip { animation: spinReel 0.08s linear infinite; }

        @keyframes spinReel {
            0% { transform: translateY(0); }
            100% { transform: translateY(calc(var(--symbol-height) * -1)); }
        }

        .symbol {
            width: var(--reel-width);
            height: var(--symbol-height);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }

        .symbol-content {
            font-size: 50px;
            line-height: 1;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.8));
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        }

        .symbol.winner { background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%); }
        .symbol.winner .symbol-content { animation: winBounce 0.4s ease-in-out; }

        @keyframes winBounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        .symbol.winner::after {
            content: '';
            position: absolute;
            inset: 3px;
            border: 2px solid var(--gold);
            border-radius: 6px;
            opacity: 0.8;
        }

        .symbol.sticky-symbol { background: radial-gradient(circle, rgba(255, 20, 147, 0.3) 0%, transparent 70%); }
        .symbol.sticky-symbol::before { content: 'üîí'; position: absolute; top: 3px; right: 3px; font-size: 12px; }

        .controls-section { display: flex; flex-direction: column; gap: 10px; }
        .bet-row { display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }

        .multiplier-btn {
            padding: 10px 16px;
            border-radius: 6px;
            border: 2px solid var(--gold);
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
            color: var(--gold);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 50px;
        }

        .multiplier-btn:hover { background: linear-gradient(180deg, #3a3a5a 0%, #2a2a3e 100%); transform: translateY(-2px); }
        .multiplier-btn.active { background: linear-gradient(180deg, var(--gold) 0%, var(--gold-dark) 100%); color: #000; }

        .bet-info-row { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }

        .info-group {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .info-label { font-size: 0.6rem; color: #888; }
        .info-value { font-size: 0.95rem; color: white; font-weight: bold; min-width: 25px; text-align: center; }

        .lines-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
            color: var(--gold);
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lines-btn:hover { background: linear-gradient(180deg, #3a3a5a 0%, #2a2a3e 100%); }

        .action-row { display: flex; justify-content: center; align-items: center; gap: 20px; }

        .spin-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--gold);
            background: linear-gradient(180deg, var(--casino-red) 0%, #8b0000 100%);
            color: white;
            font-family: 'Russo One', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5), 0 0 30px rgba(220, 20, 60, 0.3);
        }

        .spin-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 8px 35px rgba(0, 0, 0, 0.6), 0 0 45px rgba(220, 20, 60, 0.5); }
        .spin-btn:active:not(:disabled) { transform: scale(0.95); }
        .spin-btn:disabled { background: linear-gradient(180deg, #444 0%, #222 100%); cursor: not-allowed; box-shadow: none; }
        .spin-btn.stop-mode { background: linear-gradient(180deg, var(--neon-orange) 0%, #cc4400 100%); animation: stopPulse 0.4s infinite alternate; }

        @keyframes stopPulse { from { box-shadow: 0 0 15px rgba(255, 102, 0, 0.4); } to { box-shadow: 0 0 30px rgba(255, 102, 0, 0.7); } }

        .spin-btn.free-spin { background: linear-gradient(180deg, var(--neon-green) 0%, #228b22 100%); }

        .side-btn {
            padding: 14px 20px;
            border-radius: 8px;
            border: 2px solid var(--gold);
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
            color: var(--gold);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .side-btn:hover { background: linear-gradient(180deg, #3a3a5a 0%, #2a2a3e 100%); }
        .side-btn.active { background: linear-gradient(180deg, var(--casino-red) 0%, #8b0000 100%); color: white; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal-content {
            background: linear-gradient(180deg, var(--casino-purple) 0%, var(--casino-dark) 100%);
            border-radius: 15px;
            padding: 20px;
            max-width: 450px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--gold);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px; right: 10px;
            background: var(--casino-red);
            border: none;
            color: white;
            width: 30px; height: 30px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .modal-title { text-align: center; color: var(--gold); font-size: 1.1rem; margin-bottom: 15px; font-family: 'Righteous', cursive; }

        .paytable-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .paytable-item { display: flex; align-items: center; gap: 8px; background: rgba(0, 0, 0, 0.4); padding: 8px; border-radius: 8px; }
        .paytable-symbol { font-size: 1.8rem; font-family: "Apple Color Emoji", "Segoe UI Emoji", sans-serif; }
        .paytable-name { font-size: 0.65rem; color: #ccc; }
        .paytable-value { font-size: 0.75rem; color: var(--gold); font-weight: bold; }
        .paytable-special { font-size: 0.55rem; color: var(--neon-pink); }

        .paytable-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; }
        .paytable-section h3 { color: var(--gold); font-size: 0.85rem; margin-bottom: 8px; }
        .paytable-section p { font-size: 0.65rem; color: #aaa; line-height: 1.4; }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .popup-overlay.active { display: flex; }
        .popup-content { text-align: center; animation: popupAppear 0.4s ease-out; }

        @keyframes popupAppear { from { transform: scale(0) rotate(-10deg); opacity: 0; } to { transform: scale(1) rotate(0); opacity: 1; } }

        .popup-title {
            font-family: 'Righteous', cursive;
            font-size: 2.5rem;
            background: linear-gradient(180deg, var(--gold) 0%, #ff6b00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titlePulse 0.25s ease-in-out infinite alternate;
        }

        @keyframes titlePulse { from { transform: scale(1) rotate(-1deg); } to { transform: scale(1.05) rotate(1deg); } }

        .popup-subtitle { font-size: 1rem; color: #ccc; margin-top: 5px; }
        .popup-amount { font-size: 2.5rem; color: var(--neon-green); font-weight: 900; text-shadow: 0 0 30px var(--neon-green); margin-top: 10px; }
        .popup-detail { font-size: 0.9rem; color: var(--gold); margin-top: 10px; }

        @media (min-width: 768px) {
            .game-container { max-width: 750px; padding: 20px; }
            :root { --reel-width: 110px; --symbol-height: 100px; }
            .logo { font-size: 1.7rem; }
            .symbol-content { font-size: 58px; }
            .spin-btn { width: 110px; height: 110px; }
            .line-number { width: 24px; height: 19px; font-size: 8.5px; }
            .line-numbers { width: 30px; }
        }

        @media (max-width: 480px) {
            body { padding: 5px; }
            .game-container { padding: 10px; border-width: 2px; }
            :root { --reel-width: 56px; --symbol-height: 56px; }
            .logo { font-size: 1.1rem; }
            .header-btn { padding: 5px 8px; font-size: 0.5rem; }
            .stats-bar { gap: 4px; }
            .stat-box { min-width: 70px; padding: 5px 8px; }
            .stat-label { font-size: 0.4rem; }
            .stat-value { font-size: 0.8rem; }
            .slot-machine { padding: 6px; }
            .reels-container { gap: 2px; }
            .symbol-content { font-size: 30px; }
            .line-numbers { width: 20px; }
            .line-number { width: 16px; height: 13px; font-size: 6px; }
            .multiplier-btn { padding: 8px 10px; font-size: 0.65rem; min-width: 40px; }
            .spin-btn { width: 75px; height: 75px; font-size: 0.85rem; border-width: 3px; }
            .side-btn { padding: 10px 14px; font-size: 0.6rem; }
            .popup-title { font-size: 1.8rem; }
            .popup-amount { font-size: 1.8rem; }
            .payline-line { stroke-width: 2.5; }
            .payline-glow { stroke-width: 6; }
        }

        @media (max-width: 360px) {
            :root { --reel-width: 48px; --symbol-height: 48px; }
            .symbol-content { font-size: 26px; }
            .line-number { width: 14px; height: 11px; font-size: 5px; }
            .line-numbers { width: 18px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="logo">William's Slots</div>
            <div class="header-buttons">
                <button class="header-btn" id="soundBtn" onclick="toggleSound()">üîä Sound</button>
                <button class="header-btn" onclick="togglePaytable()">üìã Pay Table</button>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-box">
                <div class="stat-label">BALANCE</div>
                <div class="stat-value balance-value" id="balance">50,000</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">WIN</div>
                <div class="stat-value win-value" id="lastWin">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">TOTAL BET</div>
                <div class="stat-value" id="totalBet">125</div>
            </div>
        </div>

        <div class="win-message">
            <div class="win-message-text" id="winMessage"></div>
        </div>

        <div class="bonus-banner free-spins" id="freeSpinsBanner">
            ‚≠ê FREE SPINS: <span id="freeSpinsCount">0</span> | BONUS WIN: <span id="bonusWinTotal">0</span> ‚≠ê
        </div>
        <div class="bonus-banner sticky-bonus" id="stickyBonusBanner">üí∞ STICKY BONUS RESPIN! üí∞</div>

        <div class="slot-machine" id="slotMachine">
            <div class="reels-area">
                <div class="line-numbers" id="lineNumbersLeft"></div>
                <div class="reels-wrapper" id="reelsWrapper">
                    <div class="reels-container" id="reelsContainer"></div>
                    <svg class="paylines-overlay" id="paylinesOverlay" preserveAspectRatio="none"></svg>
                </div>
                <div class="line-numbers" id="lineNumbersRight"></div>
            </div>
        </div>

        <div class="controls-section">
            <div class="bet-row">
                <button class="multiplier-btn" data-mult="1">1X</button>
                <button class="multiplier-btn" data-mult="2">2X</button>
                <button class="multiplier-btn active" data-mult="5">5X</button>
                <button class="multiplier-btn" data-mult="10">10X</button>
                <button class="multiplier-btn" data-mult="50">50X</button>
                <button class="multiplier-btn" data-mult="100">100X</button>
            </div>

            <div class="bet-info-row">
                <div class="info-group">
                    <span class="info-label">LINES</span>
                    <button class="lines-btn" onclick="adjustLines(-1)">-</button>
                    <span class="info-value" id="linesDisplay">25</span>
                    <button class="lines-btn" onclick="adjustLines(1)">+</button>
                </div>
                <div class="info-group">
                    <span class="info-label">BET/LINE</span>
                    <span class="info-value" id="betPerLine">5</span>
                </div>
            </div>

            <div class="action-row">
                <button class="side-btn" onclick="maxBet()">MAX BET</button>
                <button class="spin-btn" id="spinBtn" onclick="handleSpinClick()">SPIN</button>
                <button class="side-btn" id="autoSpinBtn" onclick="toggleAutoSpin()">AUTO</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="paytableModal">
        <div class="modal-content">
            <button class="modal-close" onclick="togglePaytable()">√ó</button>
            <h2 class="modal-title">üíé PAY TABLE üíé</h2>
            <div class="paytable-grid" id="paytableGrid"></div>
            <div class="paytable-section">
                <h3>üÉè WILD Symbol</h3>
                <p>Substitutes for all symbols except BONUS. Highest paying symbol!</p>
            </div>
            <div class="paytable-section">
                <h3>üí∞ BONUS Symbol</h3>
                <p>Land 3+ BONUS symbols anywhere to trigger STICKY BONUS! Symbols lock and reels respin for bigger wins and FREE SPINS!</p>
            </div>
            <div class="paytable-section">
                <h3>üìä 25 Paylines</h3>
                <p>Wins pay left to right on active lines. Match 3+ symbols to win! Use the LINES control to adjust how many paylines are active (1-25).</p>
            </div>
        </div>
    </div>

    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-content">
            <div class="popup-title" id="popupTitle">BIG WIN!</div>
            <div class="popup-subtitle" id="popupSubtitle"></div>
            <div class="popup-amount" id="popupAmount">0</div>
            <div class="popup-detail" id="popupDetail"></div>
        </div>
    </div>

    <script>
        /* ============================================
           CONFIGURATION
           ============================================ */
        const CONFIG = {
            REEL_COUNT: 5,
            VISIBLE_ROWS: 3,
            SYMBOLS_PER_REEL: 60,
            STARTING_BALANCE: 50000,
            BASE_BET: 1,
            DEFAULT_MULTIPLIER: 5,
            DEFAULT_LINES: 25,
            MAX_LINES: 25,
            MIN_LINES: 1,
            SPIN_MIN_DURATION: 600,
            REEL_STOP_INTERVAL: 180,
            SCATTERS_FOR_BONUS: 3,
        };

        /* ============================================
           SYMBOLS
           ============================================ */
        const SYMBOLS = {
            seven:   { emoji: '7Ô∏è‚É£',  name: 'Lucky 7',  value: 200,  weight: 5 },
            diamond: { emoji: 'üíé',  name: 'Diamond',  value: 150,  weight: 6 },
            crown:   { emoji: 'üëë',  name: 'Crown',    value: 100,  weight: 7 },
            bell:    { emoji: 'üîî',  name: 'Bell',     value: 75,   weight: 8 },
            star:    { emoji: '‚≠ê',  name: 'Star',     value: 50,   weight: 10 },
            cherry:  { emoji: 'üçí',  name: 'Cherry',   value: 40,   weight: 11 },
            lemon:   { emoji: 'üçã',  name: 'Lemon',    value: 30,   weight: 12 },
            orange:  { emoji: 'üçä',  name: 'Orange',   value: 25,   weight: 12 },
            grape:   { emoji: 'üçá',  name: 'Grape',    value: 20,   weight: 13 },
            wild:    { emoji: 'üÉè',  name: 'WILD',     value: 500,  weight: 3, isWild: true },
            bonus:   { emoji: 'üí∞',  name: 'BONUS',    value: 0,    weight: 2, isBonus: true }
        };

        /* ============================================
           25 PAYLINES (industry standard 3√ó5 grid)
           0=top, 1=middle, 2=bottom
           ============================================ */
        const LINE_COLORS = [
            '#FF0000','#00FF00','#0066FF','#FFFF00','#FF00FF',
            '#00FFFF','#FF8800','#FF69B4','#7FFF00','#9966FF',
            '#FF4444','#44FF44','#4488FF','#FFAA00','#FF44FF',
            '#44FFFF','#CC6600','#FF88AA','#88FF44','#AA44FF',
            '#FFFFFF','#FF6666','#66FF66','#6688FF','#FFDD44'
        ];

        const PAYLINES = [
            [1,1,1,1,1],[0,0,0,0,0],[2,2,2,2,2],[0,1,2,1,0],[2,1,0,1,2],
            [0,0,1,0,0],[2,2,1,2,2],[1,0,0,0,1],[1,2,2,2,1],[1,0,1,0,1],
            [1,2,1,2,1],[0,1,0,1,0],[2,1,2,1,2],[0,0,1,2,2],[2,2,1,0,0],
            [1,1,0,1,1],[1,1,2,1,1],[0,1,1,1,0],[2,1,1,1,2],[0,1,2,2,2],
            [2,1,0,0,0],[0,2,0,2,0],[2,0,2,0,2],[0,0,2,0,0],[2,2,0,2,2]
        ];

        // Left side: lines 1-13, Right side: lines 14-25
        const LEFT_LINES  = [0,1,2,3,4,5,6,7,8,9,10,11,12];
        const RIGHT_LINES = [13,14,15,16,17,18,19,20,21,22,23,24];

        /* ============================================
           SOUND SYSTEM
           ============================================ */
        let soundEnabled = true;
        let audioContext = null;

        function initAudio() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            return audioContext;
        }

        function playSound(type) {
            if (!soundEnabled) return;
            try {
                const ctx = initAudio();
                if (ctx.state === 'suspended') ctx.resume();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);

                switch(type) {
                    case 'spin':
                        osc.frequency.setValueAtTime(200, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.15, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.1);
                        break;
                    case 'stop':
                        osc.frequency.setValueAtTime(300, ctx.currentTime);
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
                        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.05);
                        break;
                    case 'win':
                        [523,659,784,1047].forEach((f, i) => {
                            const o = ctx.createOscillator(), g = ctx.createGain();
                            o.connect(g); g.connect(ctx.destination);
                            o.frequency.value = f; o.type = 'sine';
                            g.gain.setValueAtTime(0.15, ctx.currentTime + i*0.1);
                            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i*0.1 + 0.2);
                            o.start(ctx.currentTime + i*0.1); o.stop(ctx.currentTime + i*0.1 + 0.2);
                        });
                        return;
                    case 'bigwin':
                        for (let i = 0; i < 8; i++) {
                            const o = ctx.createOscillator(), g = ctx.createGain();
                            o.connect(g); g.connect(ctx.destination);
                            o.frequency.value = 400 + i*100; o.type = 'square';
                            g.gain.setValueAtTime(0.1, ctx.currentTime + i*0.08);
                            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i*0.08 + 0.15);
                            o.start(ctx.currentTime + i*0.08); o.stop(ctx.currentTime + i*0.08 + 0.15);
                        }
                        return;
                    case 'lose':
                        osc.frequency.setValueAtTime(200, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.2);
                        osc.type = 'sawtooth';
                        gain.gain.setValueAtTime(0.08, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.2);
                        break;
                    case 'bonus':
                        for (let i = 0; i < 12; i++) {
                            const o = ctx.createOscillator(), g = ctx.createGain();
                            o.connect(g); g.connect(ctx.destination);
                            o.frequency.value = 300 + (i%4)*200; o.type = 'sine';
                            g.gain.setValueAtTime(0.12, ctx.currentTime + i*0.1);
                            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i*0.1 + 0.15);
                            o.start(ctx.currentTime + i*0.1); o.stop(ctx.currentTime + i*0.1 + 0.15);
                        }
                        return;
                    case 'click':
                        osc.frequency.setValueAtTime(800, ctx.currentTime); osc.type = 'sine';
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.03);
                        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.03);
                        break;
                }
            } catch(e) {}
        }

        function toggleSound() {
            playSound('click');
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundBtn');
            btn.textContent = soundEnabled ? 'üîä Sound' : 'üîá Muted';
            btn.classList.toggle('sound-off', !soundEnabled);
        }

        /* ============================================
           GAME STATE
           ============================================ */
        let balance = CONFIG.STARTING_BALANCE;
        let betMultiplier = CONFIG.DEFAULT_MULTIPLIER;
        let activeLines = CONFIG.DEFAULT_LINES;
        let isSpinning = false;
        let canStop = false;
        let stopRequested = false;
        let autoSpinActive = false;
        let freeSpins = 0;
        let reelStrips = [];
        let currentPositions = [];
        let lastWin = 0;
        let stickyBonusActive = false;
        let stickyPositions = [];
        let bonusRoundActive = false;
        let bonusRoundWinTotal = 0;
        let bonusSpinsUsed = 0;
        let currentWinningLines = [];

        /* ============================================
           INIT
           ============================================ */
        function init() {
            generateLineNumbers();
            for (let i = 0; i < CONFIG.REEL_COUNT; i++) {
                reelStrips.push(generateReelStrip());
                currentPositions.push(Math.floor(Math.random() * 15) + 5);
            }
            renderReels();
            renderPaytable();
            setupBetButtons();
            updateAllDisplays();
            for (let i = 0; i < CONFIG.REEL_COUNT; i++) updateReelPosition(i, currentPositions[i]);
            document.body.addEventListener('click', () => initAudio(), { once: true });
        }

        /* ============================================
           LINE NUMBERS
           ============================================ */
        function generateLineNumbers() {
            const left = document.getElementById('lineNumbersLeft');
            const right = document.getElementById('lineNumbersRight');
            left.innerHTML = ''; right.innerHTML = '';

            LEFT_LINES.forEach(idx => {
                const n = document.createElement('div');
                n.className = 'line-number'; n.id = `line-num-${idx}`;
                n.textContent = idx + 1;
                n.style.backgroundColor = LINE_COLORS[idx];
                left.appendChild(n);
            });
            RIGHT_LINES.forEach(idx => {
                const n = document.createElement('div');
                n.className = 'line-number'; n.id = `line-num-${idx}`;
                n.textContent = idx + 1;
                n.style.backgroundColor = LINE_COLORS[idx];
                right.appendChild(n);
            });
        }

        function highlightWinningLineNumbers(lineIndices) {
            document.querySelectorAll('.line-number').forEach(el => el.classList.remove('winner'));
            lineIndices.forEach(idx => {
                const el = document.getElementById(`line-num-${idx}`);
                if (el) el.classList.add('winner');
            });
        }

        function setupBetButtons() {
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (isSpinning) return;
                    playSound('click');
                    document.querySelectorAll('.multiplier-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    betMultiplier = parseInt(btn.dataset.mult);
                    updateAllDisplays();
                });
            });
        }

        /* ============================================
           REELS
           ============================================ */
        function generateReelStrip() {
            const pool = [];
            Object.keys(SYMBOLS).forEach(key => {
                for (let i = 0; i < SYMBOLS[key].weight; i++) pool.push(key);
            });
            const strip = [];
            for (let i = 0; i < CONFIG.SYMBOLS_PER_REEL; i++) {
                strip.push(pool[Math.floor(Math.random() * pool.length)]);
            }
            return strip;
        }

        function renderReels() {
            const container = document.getElementById('reelsContainer');
            container.innerHTML = '';
            for (let i = 0; i < CONFIG.REEL_COUNT; i++) {
                const reel = document.createElement('div');
                reel.className = 'reel'; reel.id = `reel-${i}`;
                const strip = document.createElement('div');
                strip.className = 'reel-strip'; strip.id = `strip-${i}`;
                const tripled = [...reelStrips[i], ...reelStrips[i], ...reelStrips[i]];
                tripled.forEach((key, idx) => {
                    const sym = document.createElement('div');
                    sym.className = 'symbol';
                    sym.dataset.index = idx % CONFIG.SYMBOLS_PER_REEL;
                    sym.dataset.symbol = key;
                    const c = document.createElement('div');
                    c.className = 'symbol-content';
                    c.textContent = SYMBOLS[key].emoji;
                    sym.appendChild(c);
                    strip.appendChild(sym);
                });
                reel.appendChild(strip);
                container.appendChild(reel);
            }
        }

        function updateReelPosition(reelIndex, position) {
            const strip = document.getElementById(`strip-${reelIndex}`);
            if (!strip) return;
            const h = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--symbol-height'));
            strip.style.transform = `translateY(-${position * h}px)`;
        }

        /* ============================================
           SVG PAYLINE DRAWING
           ============================================ */
        function getReelGeometry() {
            const wrapper = document.getElementById('reelsWrapper');
            const container = document.getElementById('reelsContainer');
            if (!wrapper || !container) return null;
            const wRect = wrapper.getBoundingClientRect();
            const reels = container.querySelectorAll('.reel');
            if (!reels.length) return null;

            const reelCenters = [];
            for (const r of reels) {
                const rr = r.getBoundingClientRect();
                reelCenters.push(rr.left - wRect.left + rr.width / 2);
            }
            const firstReel = reels[0].getBoundingClientRect();
            const rowH = firstReel.height / CONFIG.VISIBLE_ROWS;
            const topOff = firstReel.top - wRect.top;
            const rowCenters = [];
            for (let r = 0; r < CONFIG.VISIBLE_ROWS; r++) {
                rowCenters.push(topOff + r * rowH + rowH / 2);
            }
            return { width: wRect.width, height: wRect.height, reelCenters, rowCenters };
        }

        function drawPaylines(winningLines) {
            const svg = document.getElementById('paylinesOverlay');
            svg.innerHTML = '';
            const geo = getReelGeometry();
            if (!geo) return;
            svg.setAttribute('viewBox', `0 0 ${geo.width} ${geo.height}`);

            // Use a DocumentFragment for batch DOM insertion
            const frag = document.createDocumentFragment();

            winningLines.forEach(line => {
                const color = LINE_COLORS[line.lineIndex] || '#FFF';
                const pts = [];
                for (let col = 0; col < CONFIG.REEL_COUNT; col++) {
                    pts.push(`${geo.reelCenters[col]},${geo.rowCenters[line.pattern[col]]}`);
                }
                const d = `M ${pts.join(' L ')}`;

                // Glow
                const glow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                glow.setAttribute('d', d);
                glow.setAttribute('stroke', color);
                glow.setAttribute('class', 'payline-glow active');
                frag.appendChild(glow);

                // Line
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', d);
                path.setAttribute('stroke', color);
                path.setAttribute('class', 'payline-line active');
                frag.appendChild(path);

                // Dots on matched positions
                for (let col = 0; col < line.matchCount; col++) {
                    const cx = geo.reelCenters[col];
                    const cy = geo.rowCenters[line.pattern[col]];
                    const outer = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    outer.setAttribute('cx', cx); outer.setAttribute('cy', cy);
                    outer.setAttribute('r', 8); outer.setAttribute('fill', color);
                    outer.setAttribute('class', 'payline-dot active');
                    frag.appendChild(outer);
                    const inner = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    inner.setAttribute('cx', cx); inner.setAttribute('cy', cy);
                    inner.setAttribute('r', 4); inner.setAttribute('fill', '#FFF');
                    inner.setAttribute('class', 'payline-dot active');
                    frag.appendChild(inner);
                }
            });

            svg.appendChild(frag);
        }

        function clearPaylines() {
            document.getElementById('paylinesOverlay').innerHTML = '';
        }

        /* ============================================
           SPIN LOGIC
           ============================================ */
        function handleSpinClick() {
            playSound('click');
            if (isSpinning && canStop) stopRequested = true;
            else if (!isSpinning) spin();
        }

        async function spin() {
            if (isSpinning) return;
            const totalBet = getTotalBet();
            if (freeSpins === 0 && !stickyBonusActive && balance < totalBet) {
                showWinMessage('üí∏ Not enough credits!');
                return;
            }
            isSpinning = true; canStop = false; stopRequested = false;
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.textContent = 'SPIN';
            spinBtn.classList.remove('stop-mode', 'free-spin');
            clearWinEffects();
            currentWinningLines = [];
            playSound('spin');

            if (freeSpins > 0) {
                freeSpins--; bonusSpinsUsed++;
                updateFreeSpinsDisplay();
            } else if (!stickyBonusActive) {
                balance -= totalBet;
                if (bonusRoundActive) { bonusRoundActive = false; bonusRoundWinTotal = 0; bonusSpinsUsed = 0; }
            }
            updateAllDisplays();

            const targets = stickyBonusActive ? generateStickySpinResult() : generateSpinResult();
            await animateSpin(targets);
            currentPositions = targets;
            await processWins();

            if (bonusRoundActive && freeSpins === 0 && !stickyBonusActive) {
                showBonusSummary();
                bonusRoundActive = false;
            }
            isSpinning = false;
            updateSpinButton();

            if (autoSpinActive) {
                if (freeSpins > 0) setTimeout(() => spin(), 1200);
                else if (!stickyBonusActive && balance >= getTotalBet()) setTimeout(() => spin(), 1500);
                else if (balance < getTotalBet()) {
                    autoSpinActive = false;
                    document.getElementById('autoSpinBtn').classList.remove('active');
                    document.getElementById('autoSpinBtn').textContent = 'AUTO';
                }
            }
        }

        async function animateSpin(targets) {
            const spinBtn = document.getElementById('spinBtn');
            for (let i = 0; i < CONFIG.REEL_COUNT; i++) {
                if (stickyBonusActive && isReelSticky(i)) continue;
                document.getElementById(`reel-${i}`).classList.add('spinning');
            }
            await delay(CONFIG.SPIN_MIN_DURATION / 2);
            canStop = true;
            spinBtn.textContent = 'STOP';
            spinBtn.classList.add('stop-mode');
            await delay(CONFIG.SPIN_MIN_DURATION / 2);

            const h = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--symbol-height'));
            for (let i = 0; i < CONFIG.REEL_COUNT; i++) {
                if (stickyBonusActive && isReelSticky(i)) continue;
                const reel = document.getElementById(`reel-${i}`);
                const strip = document.getElementById(`strip-${i}`);
                reel.classList.remove('spinning');
                playSound('stop');
                strip.style.transition = 'transform 0.15s cubic-bezier(0.2, 0.8, 0.3, 1.05)';
                strip.style.transform = `translateY(-${targets[i] * h}px)`;
                if (!stopRequested && i < CONFIG.REEL_COUNT - 1) await delay(CONFIG.REEL_STOP_INTERVAL);
                else if (i < CONFIG.REEL_COUNT - 1) await delay(40);
                strip.style.transition = '';
            }
            canStop = false;
            await delay(100);
        }

        /* ============================================
           WIN PROCESSING
           ============================================ */
        async function processWins() {
            const bonusPos = findBonusPositions();
            if (bonusPos.length >= CONFIG.SCATTERS_FOR_BONUS && !stickyBonusActive) {
                playSound('bonus');
                stickyBonusActive = true; stickyPositions = bonusPos;
                showStickySymbols();
                document.getElementById('stickyBonusBanner').classList.add('active');
                showWinMessage('üí∞ STICKY BONUS ACTIVATED! üí∞');
                await delay(1500); isSpinning = false;
                setTimeout(() => spin(), 500);
                return;
            } else if (stickyBonusActive) {
                const newB = findNewBonusPositions(bonusPos);
                if (newB.length > 0) {
                    playSound('bonus');
                    stickyPositions = [...stickyPositions, ...newB];
                    showStickySymbols();
                    await delay(1000); isSpinning = false;
                    setTimeout(() => spin(), 500);
                    return;
                } else {
                    const sw = calculateStickyWin();
                    balance += sw; bonusRoundWinTotal += sw;
                    const spins = stickyPositions.length >= 6 ? 10 : stickyPositions.length >= 4 ? 7 : 5;
                    freeSpins += spins; bonusRoundActive = true; bonusSpinsUsed = 0;
                    playSound('bigwin');
                    showWinMessage(`üí∞ STICKY WIN: ${sw.toLocaleString()} + ${spins} FREE SPINS!`);
                    stickyBonusActive = false; stickyPositions = [];
                    clearStickySymbols();
                    document.getElementById('stickyBonusBanner').classList.remove('active');
                    updateFreeSpinsDisplay(); updateAllDisplays();
                    lastWin = sw;
                    document.getElementById('lastWin').textContent = lastWin.toLocaleString();
                    return;
                }
            }

            const result = checkAllWins();
            if (result.totalWin > 0) {
                balance += result.totalWin; lastWin = result.totalWin;
                if (bonusRoundActive || freeSpins > 0) {
                    bonusRoundWinTotal += result.totalWin;
                    document.getElementById('bonusWinTotal').textContent = bonusRoundWinTotal.toLocaleString();
                }
                currentWinningLines = result.winningLines;
                drawPaylines(currentWinningLines);
                highlightWinningLineNumbers(result.winningLines.map(l => l.lineIndex));
                highlightWinners(result.winningPositions, result.winningColumns);
                updateAllDisplays();
                const tb = getTotalBet();
                if (result.totalWin >= tb * 15) { playSound('bigwin'); showBigWin(result.totalWin, 'MEGA WIN!'); }
                else if (result.totalWin >= tb * 8) { playSound('bigwin'); showBigWin(result.totalWin, 'BIG WIN!'); }
                else { playSound('win'); showWinMessage(`‚ú® WIN! +${result.totalWin.toLocaleString()}`); }
            } else {
                playSound('lose');
                if (!bonusRoundActive) { lastWin = 0; document.getElementById('lastWin').textContent = '0'; }
            }
        }

        function generateSpinResult() {
            const p = [];
            for (let i = 0; i < CONFIG.REEL_COUNT; i++)
                p.push(Math.floor(Math.random() * (CONFIG.SYMBOLS_PER_REEL - CONFIG.VISIBLE_ROWS - 5)) + 5);
            return p;
        }

        function generateStickySpinResult() {
            const p = [...currentPositions];
            for (let i = 0; i < CONFIG.REEL_COUNT; i++)
                if (!isReelSticky(i))
                    p[i] = Math.floor(Math.random() * (CONFIG.SYMBOLS_PER_REEL - CONFIG.VISIBLE_ROWS - 5)) + 5;
            return p;
        }

        function isReelSticky(ri) { return stickyPositions.some(p => p.reel === ri); }

        /* ============================================
           PAYLINE CHECK
           ============================================ */
        function checkAllWins() {
            let totalWin = 0;
            const winPos = new Set(), winCols = new Set(), winLines = [];
            const grid = getVisibleGrid();
            for (let li = 0; li < activeLines; li++) {
                const r = checkPayline(grid, PAYLINES[li], li);
                if (r.win > 0) {
                    totalWin += r.win;
                    r.positions.forEach(p => { winPos.add(p); winCols.add(parseInt(p.split('-')[1])); });
                    winLines.push({ lineIndex: li, pattern: PAYLINES[li], matchCount: r.matchCount });
                }
            }
            return { totalWin: Math.floor(totalWin), winningPositions: winPos, winningColumns: winCols, winningLines: winLines };
        }

        function getVisibleGrid() {
            const grid = [];
            for (let r = 0; r < CONFIG.VISIBLE_ROWS; r++) {
                const row = [];
                for (let c = 0; c < CONFIG.REEL_COUNT; c++) {
                    row.push(reelStrips[c][(currentPositions[c] + r) % CONFIG.SYMBOLS_PER_REEL]);
                }
                grid.push(row);
            }
            return grid;
        }

        function checkPayline(grid, pattern) {
            const syms = pattern.map((row, col) => ({ symbol: grid[row][col], row, col }));
            let matchSym = null, matchCount = 0;
            const positions = [];
            for (let i = 0; i < syms.length; i++) {
                const cur = syms[i], data = SYMBOLS[cur.symbol];
                if (!data || data.isBonus) break;
                if (matchSym === null) {
                    matchSym = data.isWild ? 'wild' : cur.symbol;
                    matchCount = 1;
                    positions.push(`${cur.row}-${cur.col}`);
                } else {
                    if (cur.symbol === matchSym || data.isWild || matchSym === 'wild') {
                        matchCount++;
                        positions.push(`${cur.row}-${cur.col}`);
                        if (matchSym === 'wild' && !data.isWild) matchSym = cur.symbol;
                    } else break;
                }
            }
            if (matchCount < 3) return { win: 0, matchCount: 0, positions: [] };
            const sym = matchSym === 'wild' ? 'wild' : matchSym;
            const baseVal = SYMBOLS[sym]?.value || 20;
            const bet = betMultiplier * CONFIG.BASE_BET;
            const mults = { 3: 1, 4: 3, 5: 10 };
            // Win formula: /35 (was /50 in v8) for ~43% higher payouts
            return { win: (bet * baseVal * mults[matchCount]) / 35, matchCount, positions };
        }

        /* ============================================
           BONUS
           ============================================ */
        function findBonusPositions() {
            const grid = getVisibleGrid(), pos = [];
            for (let r = 0; r < CONFIG.VISIBLE_ROWS; r++)
                for (let c = 0; c < CONFIG.REEL_COUNT; c++)
                    if (SYMBOLS[grid[r][c]]?.isBonus) pos.push({ reel: c, row: r });
            return pos;
        }

        function findNewBonusPositions(all) {
            return all.filter(p => !stickyPositions.some(sp => sp.reel === p.reel && sp.row === p.row));
        }

        function showStickySymbols() {
            stickyPositions.forEach(pos => {
                document.getElementById(`reel-${pos.reel}`).classList.add('sticky');
                const strip = document.getElementById(`strip-${pos.reel}`);
                const syms = strip.querySelectorAll('.symbol');
                const idx = currentPositions[pos.reel] + pos.row;
                if (syms[idx]) syms[idx].classList.add('sticky-symbol');
            });
        }

        function clearStickySymbols() {
            document.querySelectorAll('.reel.sticky').forEach(r => r.classList.remove('sticky'));
            document.querySelectorAll('.symbol.sticky-symbol').forEach(s => s.classList.remove('sticky-symbol'));
        }

        function calculateStickyWin() {
            const tb = getTotalBet(), count = stickyPositions.length;
            const m = { 3:3, 4:5, 5:10, 6:20, 7:35, 8:50, 9:75, 10:100 };
            return tb * (m[Math.min(count, 10)] || count * 10);
        }

        /* ============================================
           UI
           ============================================ */
        function highlightWinners(positions, columns) {
            positions.forEach(pos => {
                const [row, col] = pos.split('-').map(Number);
                const strip = document.getElementById(`strip-${col}`);
                const syms = strip.querySelectorAll('.symbol');
                const idx = currentPositions[col] + row;
                if (syms[idx]) syms[idx].classList.add('winner');
            });
            columns.forEach(col => {
                const reel = document.getElementById(`reel-${col}`);
                if (reel) reel.classList.add('winner-column');
            });
        }

        function clearWinEffects() {
            document.querySelectorAll('.symbol.winner').forEach(el => el.classList.remove('winner'));
            document.querySelectorAll('.reel.winner-column').forEach(el => el.classList.remove('winner-column'));
            document.querySelectorAll('.line-number.winner').forEach(el => el.classList.remove('winner'));
            clearPaylines();
            document.getElementById('winMessage').classList.remove('show');
            document.getElementById('lastWin').classList.remove('big-win');
        }

        function showWinMessage(text) {
            const el = document.getElementById('winMessage');
            el.textContent = text; el.classList.add('show');
        }

        function showBigWin(amount, title) {
            const popup = document.getElementById('popupOverlay');
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupSubtitle').textContent = '';
            document.getElementById('popupAmount').textContent = '+' + amount.toLocaleString();
            document.getElementById('popupDetail').textContent = '';
            popup.classList.add('active');
            document.getElementById('lastWin').classList.add('big-win');
            setTimeout(() => popup.classList.remove('active'), 2500);
        }

        function showBonusSummary() {
            playSound('bigwin');
            const popup = document.getElementById('popupOverlay');
            document.getElementById('popupTitle').textContent = 'üéâ BONUS COMPLETE!';
            document.getElementById('popupSubtitle').textContent = `${bonusSpinsUsed} Free Spins Used`;
            document.getElementById('popupAmount').textContent = '+' + bonusRoundWinTotal.toLocaleString();
            document.getElementById('popupDetail').textContent = 'Total Bonus Winnings';
            popup.classList.add('active');
            setTimeout(() => {
                popup.classList.remove('active');
                bonusRoundWinTotal = 0; bonusSpinsUsed = 0;
                document.getElementById('bonusWinTotal').textContent = '0';
            }, 4000);
        }

        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
        function getTotalBet() { return betMultiplier * CONFIG.BASE_BET * activeLines; }

        function updateAllDisplays() {
            document.getElementById('balance').textContent = balance.toLocaleString();
            document.getElementById('lastWin').textContent = lastWin.toLocaleString();
            document.getElementById('totalBet').textContent = getTotalBet().toLocaleString();
            document.getElementById('linesDisplay').textContent = activeLines;
            document.getElementById('betPerLine').textContent = betMultiplier * CONFIG.BASE_BET;
        }

        function updateFreeSpinsDisplay() {
            document.getElementById('freeSpinsCount').textContent = freeSpins;
            document.getElementById('freeSpinsBanner').classList.toggle('active', freeSpins > 0 || bonusRoundActive);
            updateSpinButton();
        }

        function updateSpinButton() {
            const btn = document.getElementById('spinBtn');
            btn.classList.remove('stop-mode');
            if (freeSpins > 0) { btn.classList.add('free-spin'); btn.textContent = 'FREE'; }
            else { btn.classList.remove('free-spin'); btn.textContent = 'SPIN'; }
        }

        function adjustLines(amt) {
            if (isSpinning) return;
            playSound('click');
            activeLines = Math.max(CONFIG.MIN_LINES, Math.min(CONFIG.MAX_LINES, activeLines + amt));
            updateAllDisplays();
        }

        function maxBet() {
            if (isSpinning) return;
            playSound('click');
            betMultiplier = 100; activeLines = CONFIG.MAX_LINES;
            document.querySelectorAll('.multiplier-btn').forEach(b => b.classList.toggle('active', b.dataset.mult === '100'));
            updateAllDisplays();
        }

        function toggleAutoSpin() {
            playSound('click');
            autoSpinActive = !autoSpinActive;
            const btn = document.getElementById('autoSpinBtn');
            btn.classList.toggle('active', autoSpinActive);
            btn.textContent = autoSpinActive ? 'STOP' : 'AUTO';
            if (autoSpinActive && !isSpinning) spin();
        }

        function togglePaytable() {
            playSound('click');
            document.getElementById('paytableModal').classList.toggle('active');
        }

        function renderPaytable() {
            const container = document.getElementById('paytableGrid');
            Object.entries(SYMBOLS).forEach(([key, sym]) => {
                const item = document.createElement('div');
                item.className = 'paytable-item';
                let val = `${sym.value}x`, special = '';
                if (sym.isWild) { val = '500x'; special = 'Substitutes all!'; }
                if (sym.isBonus) { val = '3+ triggers'; special = 'STICKY + FREE SPINS!'; }
                item.innerHTML = `<span class="paytable-symbol">${sym.emoji}</span><div class="paytable-info"><div class="paytable-name">${sym.name}</div><div class="paytable-value">${val}</div>${special ? `<div class="paytable-special">${special}</div>` : ''}</div>`;
                container.appendChild(item);
            });
        }

        /* ============================================
           EVENTS
           ============================================ */
        document.getElementById('paytableModal').addEventListener('click', e => {
            if (e.target.id === 'paytableModal') togglePaytable();
        });

        document.addEventListener('keydown', e => {
            if (e.code === 'Space') { e.preventDefault(); handleSpinClick(); }
            if (e.code === 'Escape') {
                document.getElementById('paytableModal').classList.remove('active');
                document.getElementById('popupOverlay').classList.remove('active');
            }
        });

        // Redraw paylines on resize for responsiveness
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (currentWinningLines.length > 0) drawPaylines(currentWinningLines);
            }, 100);
        });

        init();
    </script>
</body>
</html>
